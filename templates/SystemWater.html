{#继承父页面#}
{% extends 'module.html' %}
{#重写content#}
{% block content %}
    <div class="content-table">
        <p>1.消防系统用水量</p>
        <!--表2.1，id=1-->

        <div id="spreadsheet"></div>
        <div>
            <input type='button' class="btn-primary" value='新增' onclick="addrow()"/>
            <input type='button' class="btn-primary" value='保存' onclick="submit()"/>
            <!--<i id="ret"></i>-->
        </div>
    </div>
    {% csrf_token %}
{% endblock %}

{% block extrajs %}
    <script>
        //提交保存
        var table_id = '#spreadsheet'
        function submit() {
            txt = JSON.stringify($(table_id).jexcel('getDataAndFormula', false))
            csrf = $("input[name='csrfmiddlewaretoken']").val()
            $.post("{% url 'excel' tables.0.pid %}", {data: txt, csrfmiddlewaretoken: csrf}, function (result) {
            $.globalMessenger().post({
            message: result.data,
            hideAfter: 6,
            type: result.msg,
            //showCloseButton: true
            });
            })
        }

        $('#spreadsheet').jexcel({
            data: {{ tables.0.data|safe }},
            columns: {{ tables.0.columns|safe }},
            nestedHeaders: {{ tables.0.nested_header|safe }},
            wordWrap: true,
            allowComments: true,
            contextMenu: function (obj, x, y, e) {
                console.log(obj)
                var items = [];
                if (y != null) {
                    // Insert new row
                    if (obj.options.allowInsertRow == true) {
                        items.push({
                            title: obj.options.text.insertANewRowAfter,
                            onclick: function () {
                                obj.insertRow(1, parseInt(y));
                            }
                        });
                    }

                    if (obj.options.allowDeleteRow == true) {
                        items.push({
                            title: obj.options.text.deleteSelectedRows,
                            onclick: function () {
                                obj.deleteRow(obj.getSelectedRows().length ? undefined : parseInt(y));
                            }
                        });
                    }
                }
                return items;
            },
            text: {
                insertANewRowAfter: "插入一行",
                deleteSelectedRows: "删除选中行",
            }
        });
        var com = {{ tables.0.com|safe }} //提示字段
        var fo = {{ tables.0.fo|safe }} //公式字段
        var tal = {{ tables.0.tal|safe }}  //合计字段

        //在合计行上方添加空行，只有一个合计行时减2
        function addrow() {
            var len = $(table_id)[0].jexcel.rows.length
            if (tal.length == 0) {//没有合计字段插入到最后
                $(table_id).jexcel('insertRow', 1, len, true)
            } else {
                $(table_id).jexcel('insertRow', 1, len - 1, true)
            }

            //添加提示信息，以下两种写法均可
            for (i = 0; i < com.length; i++) {
                $(table_id).jexcel('setComments', com[i][0] + String(len), com[i][1])
            }

            //添加公式
            for (i = 0; i < fo.length; i++) {
                var id = fo[i][0] + String(len)
                var formula = '=' + fo[i][1].replace(/([A-Z])/g, "$1" + len)
                $(table_id).jexcel('setValue', id, formula)
            }

            //更新合计公式
            if (tal.length > 0) {
                for (i = 1; i < tal.length; i++) {
                    formula = '=' + tal[0] + '('
                    id = tal[i] + String(len + 1)
                    formula += tal[i] + 1 + ':' + tal[i] + String(len) + ')'
                    $(table_id).jexcel('setValue', id, formula)
                }
            }
        }
        //初始化表格，添加注释，添加公式，添加合计
        function initRows() {
            var len = $(table_id)[0].jexcel.rows.length
            if (tal.length > 0) {//去掉最后一行
                len--;
            }
            if (len == 0) {
                $(table_id).jexcel('insertRow', 1, len, true)
                len++
            }
            for (l = 1; l <= len; l++) {
                //添加注释
                for (i = 0; i < com.length; i++) {
                    $(table_id).jexcel('setComments', com[i][0] + String(l), com[i][1])
                }
                //添加公式
                for (i = 0; i < fo.length; i++) {
                    var id = fo[i][0] + String(l)
                    var formula = '=' + fo[i][1].replace(/([A-Z])/g, "$1" + l)
                    $(table_id).jexcel('setValue', id, formula)
                }
            }
            //更新合计公式
            if (tal.length > 0) {
                for (i = 1; i < tal.length; i++) {
                    formula = '=' + tal[0] + '('
                    id = tal[i] + String(len + 1)
                    formula += tal[i] + 1 + ':' + tal[i] + String(len) + ')'
                    $(table_id).jexcel('setValue', id, formula)
                }
            }
        }
        initRows();
    </script>
{% endblock %}