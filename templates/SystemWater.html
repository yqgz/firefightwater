{#继承父页面#}
{% extends 'module.html' %}
{#重写content#}
{% block content %}
    <div class="content-table">
        <p>1.消防系统用水量</p>
        <!--表2.1，id=1-->
        <div id="spreadsheet"></div>
        <div>
            <input type='button' class="btn-primary" value='新增' onclick="addrow()"/>
            <input type='button' class="btn-primary" value='保存' onclick="submit()"/><i id="ret"></i>
            {% csrf_token %}
        </div>
    </div>
{% endblock %}

{% block extrajs %}
    <script>
        //提交保存
        function submit() {
//            这是取公式的方法getValue('A1', true); // will return value from a formula
//取值getValue('A1') // will return a formula

            txt = JSON.stringify($('#spreadsheet').jexcel('getData', false))
            csrf = $("input[name='csrfmiddlewaretoken']").val()
            $.post("{% url 'excel' tables.0.pid %}", {data: txt, csrfmiddlewaretoken: csrf}, function (result) {
                $("#ret").html(result.data)
            })
        }
        //在合计行上方添加空行，只有一个合计行时减2
        function addrow() {
            var len=$('#spreadsheet')[0].jexcel.rows.length
            $('#spreadsheet').jexcel('insertRow',1,len-3)
        }
        //公式计算
        var data = [
            ['室外消火栓系统', '建筑类别1', 15, 20, 0.5, true, '=D1*E1*3600/1000', false, '这里是选择依据'],
            ['室内消火栓系统', '建筑类别2', 10, 15, 0.5, false, '=D2*E2*3600/1000', true, '填写选择依据'],
            ['合计', '', , '=SUM(D1:D2)', , , '=SUM(G1:G2)', '',],
            ['最大值', '', , '=MAX(D1:D2)', , , '=MAX(G1:G2)', '',],
        ];

        table = $('#spreadsheet').jexcel({
            data: {{ tables.0.data|safe }},
            columns: {{ tables.0.columns|safe }},
            nestedHeaders: {{ tables.0.nested_header|safe }},
            wordWrap: true,
            allowComments: true,
            contextMenu: function (obj, x, y, e) {
                console.log(obj)
                var items = [];
                if (y == null) {
                    // Sorting
                    if (obj.options.columnSorting == true) {
                        // Line
                        //items.push({ type:'line' });

                        items.push({
                            title: obj.options.text.orderAscending,
                            onclick: function () {
                                obj.orderBy(x, 0);
                            }
                        });
                        items.push({
                            title: obj.options.text.orderDescending,
                            onclick: function () {
                                obj.orderBy(x, 1);
                            }
                        });
                    }
                } else {
                    // Insert new row
                    if (obj.options.allowInsertRow == true) {
                        items.push({
                            title: obj.options.text.insertANewRowAfter,
                            onclick: function () {
                                obj.insertRow(1, parseInt(y));
                            }
                        });
                    }

                    if (obj.options.allowDeleteRow == true) {
                        items.push({
                            title: obj.options.text.deleteSelectedRows,
                            onclick: function () {
                                obj.deleteRow(obj.getSelectedRows().length ? undefined : parseInt(y));
                            }
                        });
                    }

                    /*if (x) {
                     if (obj.options.allowComments == true) {
                     items.push({ type:'line' });

                     var title = obj.records[y][x].getAttribute('title') || '';

                     items.push({
                     title: title ? obj.options.text.editComments : obj.options.text.addComments,
                     onclick:function() {
                     obj.setComments([ x, y ], prompt(obj.options.text.comments, title));
                     }
                     });
                     }
                     }*/
                }
                return items;
            },
            text: {
                insertANewRowAfter: "插入一行",
                deleteSelectedRows: "删除选中行",
            }
        });
    </script>
{% endblock %}